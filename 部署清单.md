# YouTube Planner - 部署清单

## ✅ 已完成的文件

### 后端文件
- [x] `BackendYTP/Dockerfile` - Spring Boot 多阶段构建
- [x] `BackendYTP/.dockerignore` - Docker构建排除文件
- [x] `BackendYTP/src/main/resources/application-prod.properties` - 生产环境配置
- [x] `BackendYTP/pom.xml` - 已添加 Spring Boot Actuator 依赖

### 前端文件
- [x] `frontendytp/Dockerfile` - React + Nginx 多阶段构建
- [x] `frontendytp/.dockerignore` - Docker构建排除文件
- [x] `frontendytp/nginx.conf` - Nginx配置支持SPA路由
- [x] `frontendytp/src/services/api.ts` - 已修改为支持环境变量API端点

### 配置和部署文件
- [x] `docker-compose.yml` - 本地开发测试环境
- [x] `render.yaml` - Render平台部署配置（已修复）
- [x] `render-free.yaml` - 免费套餐配置（已修复）
- [x] `render-backend-only.yaml` - 仅后端Blueprint配置（**推荐使用**）
- [x] `deploy.sh` - 部署脚本（已添加执行权限）
- [x] `Render部署方案.md` - 详细部署方案文档
- [x] `免费套餐部署指南.md` - 免费套餐专用指南
- [x] `部署清单.md` - 当前文件

## 🚀 部署步骤

### 第一步：本地测试（推荐）

```bash
# 1. 测试Docker构建
./deploy.sh build

# 2. 启动本地环境
./deploy.sh local

# 3. 检查服务状态
./deploy.sh status

# 4. 访问应用
# 前端: http://localhost:3000
# 后端: http://localhost:8080
# 健康检查: http://localhost:8080/actuator/health
```

### 第二步：推送代码到GitHub

```bash
# 1. 添加所有文件
git add .

# 2. 提交更改
git commit -m "Add Docker configuration for Render deployment"

# 3. 推送到GitHub
git push origin main
```

### 第三步：在Render部署

#### 方案A：使用Blueprint自动部署后端

**重要提示：** Render的Blueprint YAML不支持`static`类型服务，只能创建后端服务。

1. 登录 [Render](https://render.com)
2. 点击 "New +" -> "Blueprint"
3. 连接GitHub仓库
4. 选择 `render-backend-only.yaml` 文件
5. 设置必要的环境变量（见下方）
6. **前端需要手动创建** Static Site服务（见方案B）

**限制说明：**
- ❌ Blueprint不支持Static Site类型
- ❌ 免费套餐不支持持久化磁盘
- ✅ 可以自动创建后端Web Service

#### 方案B：手动创建服务

**后端服务：**
1. New -> Web Service
2. 连接GitHub仓库
3. 配置：
   - Name: `youtubeplanner-backend`
   - Runtime: Docker
   - Dockerfile Path: `./BackendYTP/Dockerfile`
   - Instance Type: Free

**前端服务：**
1. New -> Static Site（更经济）或 Web Service
2. 连接GitHub仓库
3. 静态站点配置：
   - Build Command: `cd frontendytp && npm ci && npm run build`
   - Publish Directory: `frontendytp/build`

## 🔧 环境变量配置

### 后端环境变量

在Render后端服务中设置以下环境变量：

```
SPRING_PROFILES_ACTIVE=prod
SPRING_DATASOURCE_URL=jdbc:postgresql://db.nvcagxykymgtmprggwhy.supabase.co:5432/postgres
SPRING_DATASOURCE_USERNAME=postgres
SPRING_DATASOURCE_PASSWORD=OtvO9P8X36b3up5x
JWT_SECRET=404E635266556A586E3272357538782F413F4428472B4B6250645367566B5970
JWT_ACCESS_TOKEN_EXPIRATION=3600
JWT_REFRESH_TOKEN_EXPIRATION=604800
CORS_ALLOWED_ORIGINS=https://your-frontend-service.onrender.com
```

### 前端环境变量

在Render前端服务中设置：

```
REACT_APP_API_BASE_URL=https://your-backend-service.onrender.com/api/v1
```

**免费套餐特殊步骤：**

1. 先部署后端服务，获取后端URL
2. 将后端URL复制（例如：`https://youtubeplanner-backend-xxx.onrender.com`）
3. 在前端服务的环境变量中设置完整的API URL
4. 在后端服务的 `CORS_ALLOWED_ORIGINS` 中设置前端URL

## 📋 部署后验证清单

### 后端验证
- [ ] 服务启动成功（Render日志无错误）
- [ ] 健康检查通过：`https://your-backend.onrender.com/actuator/health`
- [ ] 数据库连接正常
- [ ] API端点可访问

### 前端验证
- [ ] 静态文件加载正常
- [ ] 路由功能正常（刷新页面不报404）
- [ ] API调用成功
- [ ] 用户界面显示正常

### 集成测试
- [ ] 前后端通信正常
- [ ] CORS配置正确
- [ ] 用户认证流程正常
- [ ] 数据操作功能正常

## 🛠️ 故障排除

### 常见问题

1. **构建失败**
   - 检查Dockerfile语法
   - 确认依赖安装成功
   - 查看Render构建日志

2. **服务启动失败**
   - 检查环境变量配置
   - 确认端口设置正确
   - 查看应用日志

3. **CORS错误**
   - 确认CORS_ALLOWED_ORIGINS设置正确
   - 检查前端API端点配置

4. **数据库连接失败**
   - 验证数据库连接信息
   - 检查网络安全组设置

### 调试命令

```bash
# 本地调试
./deploy.sh status           # 检查服务状态
docker-compose logs -f       # 查看实时日志
docker-compose ps            # 查看容器状态

# 单独测试服务
docker build -t test-backend BackendYTP/
docker run -p 8080:8080 test-backend

docker build -t test-frontend frontendytp/
docker run -p 3000:80 test-frontend
```

## 📊 性能优化建议

### 后端优化
- JVM内存参数已在Dockerfile中优化
- 数据库连接池配置已优化
- 生产环境日志级别已调整

### 前端优化
- Gzip压缩已启用
- 静态资源缓存策略已配置
- Bundle大小优化（移除source maps）

## 💰 成本估算

**Render免费额度：**
- 后端 Web Service: 750小时/月（免费）
- 前端 Static Site: 无限制（免费）
- 带宽: 100GB/月（免费）

**预计成本：** $0/月（在免费额度内）

## 📈 扩展计划

### 短期
- [ ] 监控和告警配置
- [ ] 自动化测试集成
- [ ] 日志聚合和分析

### 长期
- [ ] CI/CD流水线
- [ ] 多环境部署
- [ ] 性能监控
- [ ] 备份和灾难恢复

---

**创建时间：** 2024年12月
**最后更新：** 2024年12月
**状态：** ✅ 准备就绪 