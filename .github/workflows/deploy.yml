name: ğŸš€ Deploy to AWS EC2 (Optimized)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}/backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend
  API_BASE_URL: https://youtubeplanner.duckdns.org/api/v1

jobs:
  # æ„å»ºä½œä¸š - å¹¶è¡Œæ„å»ºå‰åç«¯
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [frontend, backend]
    outputs:
      frontend-image: ${{ steps.meta-frontend.outputs.tags }}
      backend-image: ${{ steps.meta-backend.outputs.tags }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ·ï¸ Extract metadata (Frontend)
      if: matrix.component == 'frontend'
      id: meta-frontend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: ğŸ·ï¸ Extract metadata (Backend)
      if: matrix.component == 'backend'
      id: meta-backend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    # Frontend æ„å»º
    - name: ğŸŸ¢ Setup Node.js
      if: matrix.component == 'frontend'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontendytp/package-lock.json
        
    - name: ğŸ”¨ Build Frontend
      if: matrix.component == 'frontend'
      run: |
        cd frontendytp
        npm ci --prefer-offline
        CI=false REACT_APP_API_BASE_URL=${{ env.API_BASE_URL }} npm run build
        
    - name: ğŸ³ Build Frontend Docker Image
      if: matrix.component == 'frontend'
      run: |
        docker build \
          --build-arg REACT_APP_API_BASE_URL=${{ env.API_BASE_URL }} \
          --tag youtubeplanner-frontend:latest \
          --tag youtubeplanner-frontend:${{ github.sha }} \
          ./frontendytp

    # Backend æ„å»º
    - name: â˜• Setup Java
      if: matrix.component == 'backend'
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'maven'
        
    - name: ğŸ”¨ Build Backend
      if: matrix.component == 'backend'
      run: |
        cd BackendYTP
        mvn clean package -DskipTests -B -q
        
    - name: ğŸ³ Build Backend Docker Image
      if: matrix.component == 'backend'
      run: |
        docker build \
          --tag youtubeplanner-backend:latest \
          --tag youtubeplanner-backend:${{ github.sha }} \
          ./BackendYTP

    # ä¿å­˜é•œåƒ
    - name: ğŸ’¾ Save Docker Images
      run: |
        if [ "${{ matrix.component }}" == "frontend" ]; then
          docker save youtubeplanner-frontend:latest | gzip > frontend-${{ github.sha }}.tar.gz
        else
          docker save youtubeplanner-backend:latest | gzip > backend-${{ github.sha }}.tar.gz
        fi
        
    - name: ğŸ“¤ Upload Docker Images
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.component }}-image
        path: ${{ matrix.component }}-${{ github.sha }}.tar.gz
        retention-days: 1

  # éƒ¨ç½²ä½œä¸š
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download Frontend Image
      uses: actions/download-artifact@v4
      with:
        name: frontend-image
        
    - name: ğŸ“¥ Download Backend Image
      uses: actions/download-artifact@v4
      with:
        name: backend-image

    - name: ğŸ”§ Prepare deployment files
      run: |
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        mkdir -p deployment
        
        # å¤åˆ¶å¿…è¦æ–‡ä»¶
        cp docker-compose.prod.yml deployment/
        cp -r deploy-scripts deployment/
        
        # ç§»åŠ¨é•œåƒæ–‡ä»¶
        mv frontend-${{ github.sha }}.tar.gz deployment/frontend.tar.gz
        mv backend-${{ github.sha }}.tar.gz deployment/backend.tar.gz

    - name: ğŸš€ Deploy to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "deployment/*"
        target: "/home/ec2-user/youtubeplanner/"
        strip_components: 1
        timeout: 300s
        
    - name: ğŸ”„ Execute Deployment
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        timeout: 600s
        script: |
          set -e
          cd /home/ec2-user/youtubeplanner
          
          echo "ğŸ”„ Starting deployment process..."
          
          # åˆ›å»ºå¤‡ä»½
          if [ -f "docker-compose.prod.yml" ]; then
            echo "ğŸ“¦ Creating backup..."
            docker-compose -f docker-compose.prod.yml ps > deployment-backup-${{ github.sha }}.log || true
          fi
          
          # åŠ è½½æ–°é•œåƒ
          echo "ğŸ“¥ Loading Docker images..."
          docker load < backend.tar.gz
          docker load < frontend.tar.gz
          
          # ä¼˜é›…åœæ­¢ç°æœ‰æœåŠ¡
          echo "â¹ï¸ Stopping existing services..."
          docker-compose -f docker-compose.prod.yml down --timeout 30 || true
          
          # æ¸…ç†æ—§é•œåƒ
          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -f
          
          # å¯åŠ¨æ–°æœåŠ¡
          echo "ğŸš€ Starting new services..."
          docker-compose -f docker-compose.prod.yml up -d
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ Waiting for services to start..."
          sleep 45
          
          # å¥åº·æ£€æŸ¥
          echo "ğŸ¥ Performing health checks..."
          
          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          if ! docker-compose -f docker-compose.prod.yml ps | grep -q "Up"; then
            echo "âŒ Some containers are not running!"
            docker-compose -f docker-compose.prod.yml ps
            docker-compose -f docker-compose.prod.yml logs --tail=50
            exit 1
          fi
          
          # æ£€æŸ¥åç«¯å¥åº·
          for i in {1..10}; do
            if curl -f -s http://localhost:8080/actuator/health > /dev/null; then
              echo "âœ… Backend health check passed"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "âŒ Backend health check failed after 10 attempts"
              docker-compose -f docker-compose.prod.yml logs backend --tail=50
              exit 1
            fi
            echo "â³ Backend health check attempt $i/10..."
            sleep 10
          done
          
          # æ£€æŸ¥å‰ç«¯
          for i in {1..5}; do
            if curl -f -s http://localhost:3000 > /dev/null; then
              echo "âœ… Frontend health check passed"
              break
            fi
            if [ $i -eq 5 ]; then
              echo "âŒ Frontend health check failed after 5 attempts"
              docker-compose -f docker-compose.prod.yml logs frontend --tail=50
              exit 1
            fi
            echo "â³ Frontend health check attempt $i/5..."
            sleep 10
          done
          
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“Š Final container status:"
          docker-compose -f docker-compose.prod.yml ps
          
          # æ¸…ç†éƒ¨ç½²æ–‡ä»¶
          rm -f backend.tar.gz frontend.tar.gz

  # éƒ¨ç½²åéªŒè¯
  verify:
    needs: deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” Verify Deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        
        # æ£€æŸ¥å‰ç«¯
        if curl -f -s https://youtubeplanner.duckdns.org > /dev/null; then
          echo "âœ… Frontend is accessible"
        else
          echo "âŒ Frontend verification failed"
          exit 1
        fi
        
        # æ£€æŸ¥åç«¯API
        if curl -f -s https://youtubeplanner.duckdns.org/actuator/health > /dev/null; then
          echo "âœ… Backend API is accessible"
        else
          echo "âŒ Backend API verification failed"
          exit 1
        fi
        
        echo "ğŸ‰ All verification checks passed!"

    - name: ğŸ“Š Deployment Summary
      run: |
        echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployed at**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend**: https://youtubeplanner.duckdns.org" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend API**: https://youtubeplanner.duckdns.org/api/v1" >> $GITHUB_STEP_SUMMARY
        echo "- **Health Check**: https://youtubeplanner.duckdns.org/actuator/health" >> $GITHUB_STEP_SUMMARY 